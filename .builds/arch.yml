image: archlinux
packages:
  - dotnet-sdk
  - dotnet-sdk-8.0
  - dotnet-runtime
  - dotnet-runtime-8.0
  - docker
  - kubectl
sources:
  - https://git.sr.ht/~cloutier/bird.makeup
secrets:
  -  df5c6304-8a0e-495c-a55a-24ca6617a00a
  -  ec87d89b-55c6-43d4-bf36-bf6e93da089f
tasks:
  - test: |
      sudo systemctl start docker
      sudo docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=birdsitelive -e POSTGRES_USER=birdsitelive -e POSTGRES_DB=birdsitelive postgres:15
      cd bird.makeup/src
      dotnet test
  - publish-x64: |
      cd bird.makeup/src/BirdsiteLive
      dotnet publish --os linux --arch x64 /t:PublishContainer -c Release
      docker push cloutier/bird.makeup:latest
  - publish-arm: |
      cd bird.makeup/src/BirdsiteLive
      dotnet publish --os linux --arch arm64 /t:PublishContainer -c Release
      docker tag cloutier/bird.makeup:latest cloutier/bird.makeup:latest-arm
      docker push cloutier/bird.makeup:latest-arm
  - deploy: |
      cd bird.makeup/k8s
      kubectl apply -f dotmakeup.yaml
      kubectl apply -f kilogram.yaml
      kubectl apply -f hacker.yaml
